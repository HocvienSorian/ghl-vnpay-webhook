<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Cổng Thanh Toán VNPAY</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px;
      }
    </style>
  </head>
  <body>
    <h1>📟 Cổng Thanh Toán VNPAY</h1>
    <p>⏳ Đang truy vấn thông tin giao dịch từ GHL...</p>

    <script>
      const GHL_ACCESS_TOKEN = process.env.GHL_ACCESS_TOKEN; // ✔✔ Bạn cần cung cấp API Key từ .env hoặc backend inject
      const GHL_LOCATION_ID = process.env.GHL_LOCATION_ID; // ✔✔ Set thành LocationId tịnh hoặc query params URL

      async function fetchLatestTransaction() {
        try {
          const res = await fetch(
            `https://services.leadconnectorhq.com/payments/transactions?locationId=${GHL_LOCATION_ID}&limit=1`,
            {
              method: 'GET',
              headers: {
                Authorization: `Bearer ${GHL_ACCESS_TOKEN}`,
                Version: '2021-07-28',
                Accept: 'application/json'
              }
            }
          );

          const result = await res.json();
          const transaction = result?.transactions?.[0];

          if (!transaction || !transaction.id) {
            alert('Không tìm thấy giao dịch mới nhất.');
            return;
          }

          // ✔ Tạo thông tin thanh toán từ giao dịch mới nhất
          const paymentData = {
            amount: transaction.amount,
            orderId: transaction.id,
            orderInfo: 'Thanh toán VNPAY cho giao dịch ' + transaction.id,
            transactionId: transaction.id,
            contactId: transaction.contactId,
            locationId: GHL_LOCATION_ID,
            currency: transaction.currency || 'VND',
            apiKey: GHL_API_KEY
          };

          const resp = await fetch('/api/create-payment-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paymentData)
          });

          const json = await resp.json();

          if (json.paymentUrl) {
            console.log('Chuyển hướng đến VNPAY:', json.paymentUrl);
            window.location.href = json.paymentUrl;
          } else {
            alert('Lỗi khi tạo link thanh toán');
            console.error(json);
          }
        } catch (err) {
          console.error('Lỗi khi truy vấn transaction:', err);
          alert('Không thể truy xuất dữ liệu giao dịch.');
        }
      }

      window.addEventListener('load', () => {
        console.log('✨ Gửi custom_provider_ready');
        window.postMessage({ type: 'custom_provider_ready', loaded: true }, '*');
        fetchLatestTransaction();
      });
    </script>
  </body>
</html>
