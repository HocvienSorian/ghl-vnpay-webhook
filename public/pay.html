async function initiatePayment(data) {
  const ipAddr = await getClientIp();

  const paymentLink = window.location.href; // ğŸŸ¢ láº¥y URL hiá»‡n táº¡i

  const payload = {
    amount: data.amount,
    orderId: data.orderId || data.transactionId || "ORD_FALLBACK",
    orderInfo: data.contactId,
    ipAddr,
    paymentLink // ğŸŸ¢ truyá»n thÃªm paymentLink
  };

  const missing = Object.entries(payload).filter(([_, v]) => !v).map(([k]) => k);
  if (missing.length > 0) {
    console.error("âŒ Thiáº¿u trÆ°á»ng:", missing);
    alert(`âŒ Thiáº¿u dá»¯ liá»‡u báº¯t buá»™c: ${missing.join(', ')}`);
    return;
  }

  document.getElementById("status").innerText = "ğŸ”„ Äang xá»­ lÃ½ giao dá»‹ch...";

  try {
    const res = await fetch("/api/create-payment-url", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (result.paymentUrl) {
      console.log("âœ… Má»Ÿ tab má»›i tá»›i VNPAY:", result.paymentUrl);
      window.open(result.paymentUrl, "_blank");
      document.getElementById("status").innerText = "âœ… ÄÃ£ má»Ÿ trang thanh toÃ¡n.";
    } else {
      console.error("âŒ KhÃ´ng nháº­n Ä‘Æ°á»£c paymentUrl:", result);
      alert("âŒ KhÃ´ng thá»ƒ táº¡o link thanh toÃ¡n.");
    }
  } catch (err) {
    console.error("ğŸ”¥ Lá»—i gá»­i dá»¯ liá»‡u:", err);
    alert("âŒ CÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i.");
  }
}
