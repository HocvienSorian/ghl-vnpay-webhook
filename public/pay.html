<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C·ªïng Thanh To√°n VNPAY</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <h1>üßæ C·ªïng Thanh To√°n VNPAY</h1>
  <p id="status">‚è≥ ƒêang ch·ªù GHL g·ª≠i th√¥ng tin thanh to√°n...</p>

<script>
  let paymentDataReceived = false;

  window.addEventListener("load", () => {
    setTimeout(() => {
      console.log("üöÄ Iframe loaded ‚Äì g·ª≠i custom_provider_ready");
      window.postMessage({
        type: "custom_provider_ready",
        loaded: true,
        providerId: "685ca9b987c1777791c22f89"
      }, "*");
    }, 300);
  });

  async function getClientIp() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip;
    } catch (err) {
      console.warn("‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c IP, d√πng fallback");
      return "127.0.0.1";
    }
  }

  async function initiatePayment(data) {
    const ipAddr = await getClientIp();

    const payload = {
      amount: data.amount,
      orderId: data.orderId || data.transactionId || "ORD_FALLBACK",
      contactId: data.contactId || "fallback-contactId", // ‚úÖ th√™m contactId
      orderInfo: data.contactId || "fallback-contactId", // ‚úÖ v·∫´n gi·ªØ ƒë·ªÉ truy·ªÅn sang VNPAY
      ipAddr,
    };

    const missing = Object.entries(payload).filter(([_, v]) => !v).map(([k]) => k);
    if (missing.length > 0) {
      console.error("‚ùå Thi·∫øu tr∆∞·ªùng:", missing);
      alert(`‚ùå Thi·∫øu d·ªØ li·ªáu b·∫Øt bu·ªôc: ${missing.join(', ')}`);
      return;
    }

    document.getElementById("status").innerText = "üîÑ ƒêang x·ª≠ l√Ω giao d·ªãch...";

    try {
      const res = await fetch("/api/create-payment-url", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const text = await res.text();
        console.error(`‚ùå Server tr·∫£ v·ªÅ ${res.status}:`, text);
        alert(`‚ùå L·ªói server: ${res.status}`);
        return;
      }

      let result;
      try {
        result = await res.json();
      } catch (jsonErr) {
        const text = await res.text();
        console.error("‚ùå Response kh√¥ng ph·∫£i JSON:", text);
        alert("‚ùå Response kh√¥ng h·ª£p l·ªá");
        return;
      }

      if (result.paymentUrl) {
        console.log("‚úÖ M·ªü tab m·ªõi t·ªõi VNPAY:", result.paymentUrl);
        window.open(result.paymentUrl, "_blank");
        document.getElementById("status").innerText = "‚úÖ ƒê√£ m·ªü trang thanh to√°n.";
      } else {
        console.error("‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c paymentUrl:", result);
        alert("‚ùå Kh√¥ng th·ªÉ t·∫°o link thanh to√°n.");
      }
    } catch (err) {
      console.error("üî• L·ªói g·ª≠i d·ªØ li·ªáu:", err);
      alert("‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
    }
  }

  window.addEventListener("message", async (event) => {
    const data = event.data;
    console.log("üì• Nh·∫≠n d·ªØ li·ªáu t·ª´ GHL:", data);

    if (data?.type !== "payment_initiate_props") {
      console.warn("‚ö†Ô∏è Kh√¥ng ph·∫£i payment_initiate_props:", data?.type);
      return;
    }

    if (!data.contactId) {
      console.error("‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c contactId t·ª´ GHL.");
      alert("‚ùå Kh√¥ng t√¨m th·∫•y contactId t·ª´ GHL.");
      return;
    }

    paymentDataReceived = true;
    await initiatePayment(data);
  });

  setTimeout(async () => {
    if (!paymentDataReceived) {
      console.warn("‚è± Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ GHL, g·ªçi fallback...");
      try {
        const res = await fetch("/api/fetch-ghl-transaction");
        const fallbackData = await res

