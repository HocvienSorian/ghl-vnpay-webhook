<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C·ªïng Thanh To√°n VNPAY</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <h1>üßæ C·ªïng Thanh To√°n VNPAY</h1>
  <p id="status">‚è≥ ƒêang x·ª≠ l√Ω k·∫øt qu·∫£ thanh to√°n...</p>

<script>
  let fallbackData = null;

  async function handleVnpayReturn() {
    const urlParams = new URLSearchParams(window.location.search);
    const vnp_ResponseCode = urlParams.get("vnp_ResponseCode");
    const vnp_TransactionNo = urlParams.get("vnp_TransactionNo");
    const vnp_TxnRef = urlParams.get("vnp_TxnRef");

    if (!vnp_ResponseCode || !vnp_TxnRef || !vnp_TransactionNo) {
      console.log("‚ö†Ô∏è Kh√¥ng c√≥ tham s·ªë VNPAY trong URL");
      return;
    }

    document.getElementById("status").innerText = "üîç ƒêang x√°c minh giao d·ªãch...";

    try {
      if (!fallbackData) {
        const res = await fetch("/api/fetch-ghl-transaction");
        fallbackData = await res.json();
        console.log("üì¶ L·∫•y fallbackData:", fallbackData);
      }

      const res = await fetch("/api/vnpay-handler", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: "verify",
          chargeId: vnp_TransactionNo,
          transactionId: fallbackData.transactionId,
          contactId: fallbackData.contactId
        })
      });

      const result = await res.json();
      console.log("‚úÖ K·∫øt qu·∫£ verify:", result);

      if (res.ok && result.success) {
        window.parent.postMessage({
          type: "custom_element_success_response",
          chargeId: vnp_TransactionNo
        }, "*");
        document.getElementById("status").innerText = "üéâ Thanh to√°n th√†nh c√¥ng!";
      } else {
        window.parent.postMessage({
          type: "custom_element_error_response",
          error: { description: "Giao d·ªãch th·∫•t b·∫°i ho·∫∑c ch∆∞a x√°c minh." }
        }, "*");
        document.getElementById("status").innerText = "‚ùå Giao d·ªãch th·∫•t b·∫°i.";
      }
    } catch (err) {
      console.error("üî• L·ªói khi verify:", err);
      window.parent.postMessage({
        type: "custom_element_error_response",
        error: { description: "L·ªói x√°c minh giao d·ªãch." }
      }, "*");
      document.getElementById("status").innerText = "‚ùå L·ªói khi x√°c minh giao d·ªãch.";
    }
  }

  handleVnpayReturn();
</script>
</body>
</html>
