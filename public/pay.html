<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Cá»•ng Thanh ToÃ¡n VNPAY</title>
    <style>
      body {
        font-family: sans-serif;
        text-align: center;
        padding: 40px;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ“Ÿ Cá»•ng Thanh ToÃ¡n VNPAY</h1>
    <p>â³ Äang truy váº¥n thÃ´ng tin giao dá»‹ch tá»« GHL...</p>

    <script>
      const GHL_ACCESS_TOKEN = process.env.GHL_ACCESS_TOKEN; // âœ”âœ” Báº¡n cáº§n cung cáº¥p API Key tá»« .env hoáº·c backend inject
      const GHL_LOCATION_ID = process.env.GHL_LOCATION_ID; // âœ”âœ” Set thÃ nh LocationId tá»‹nh hoáº·c query params URL

      async function fetchLatestTransaction() {
        try {
          const res = await fetch(
            `https://services.leadconnectorhq.com/payments/transactions?locationId=${GHL_LOCATION_ID}&limit=1`,
            {
              method: 'GET',
              headers: {
                Authorization: `Bearer ${GHL_ACCESS_TOKEN}`,
                Version: '2021-07-28',
                Accept: 'application/json'
              }
            }
          );

          const result = await res.json();
          const transaction = result?.transactions?.[0];

          if (!transaction || !transaction.id) {
            alert('KhÃ´ng tÃ¬m tháº¥y giao dá»‹ch má»›i nháº¥t.');
            return;
          }

          // âœ” Táº¡o thÃ´ng tin thanh toÃ¡n tá»« giao dá»‹ch má»›i nháº¥t
          const paymentData = {
            amount: transaction.amount,
            orderId: transaction.id,
            orderInfo: 'Thanh toÃ¡n VNPAY cho giao dá»‹ch ' + transaction.id,
            transactionId: transaction.id,
            contactId: transaction.contactId,
            locationId: GHL_LOCATION_ID,
            currency: transaction.currency || 'VND',
            apiKey: GHL_API_KEY
          };

          const resp = await fetch('/api/create-payment-url', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paymentData)
          });

          const json = await resp.json();

          if (json.paymentUrl) {
            console.log('Chuyá»ƒn hÆ°á»›ng Ä‘áº¿n VNPAY:', json.paymentUrl);
            window.location.href = json.paymentUrl;
          } else {
            alert('Lá»—i khi táº¡o link thanh toÃ¡n');
            console.error(json);
          }
        } catch (err) {
          console.error('Lá»—i khi truy váº¥n transaction:', err);
          alert('KhÃ´ng thá»ƒ truy xuáº¥t dá»¯ liá»‡u giao dá»‹ch.');
        }
      }

      window.addEventListener('load', () => {
        console.log('âœ¨ Gá»­i custom_provider_ready');
        window.postMessage({ type: 'custom_provider_ready', loaded: true }, '*');
        fetchLatestTransaction();
      });
    </script>
  </body>
</html>
