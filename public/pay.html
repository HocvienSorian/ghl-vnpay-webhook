<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Cá»•ng Thanh ToÃ¡n VNPAY</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§¾ Cá»•ng Thanh ToÃ¡n VNPAY</h1>
  <p id="status">â³ Äang xá»­ lÃ½ giao dá»‹ch...</p>

<script>
  let paymentDataReceived = false;

  window.addEventListener("load", () => {
    setTimeout(() => {
      console.log("ğŸš€ Iframe loaded â€“ gá»­i custom_provider_ready");
      window.parent.postMessage({
        type: "custom_provider_ready",
        loaded: true,
        providerId: "685ca9b987c1777791c22f89"
      }, "*");
    }, 300);
  });

  window.addEventListener("message", async (event) => {
    const data = event.data;
    console.log("ğŸ“¥ Nháº­n dá»¯ liá»‡u tá»« GHL:", data);

    if (data?.type !== "payment_initiate_props") {
      console.warn("âš ï¸ KhÃ´ng pháº£i payment_initiate_props:", data?.type);
      return;
    }

    paymentDataReceived = true;
    await initiatePayment(data);
  });

  async function getClientIp() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip;
    } catch (err) {
      console.warn("âš ï¸ KhÃ´ng láº¥y Ä‘Æ°á»£c IP, dÃ¹ng fallback");
      return "127.0.0.1";
    }
  }

  async function initiatePayment(data) {
    const ipAddr = await getClientIp();

    const payload = {
      amount: data.amount,
      orderId: data.orderId || data.transactionId || "ORD_FALLBACK",
      orderInfo: data.contactId,
      ipAddr,
    };

    const missing = Object.entries(payload).filter(([_, v]) => !v).map(([k]) => k);
    if (missing.length > 0) {
      console.error("âŒ Thiáº¿u trÆ°á»ng:", missing);
      alert(`âŒ Thiáº¿u dá»¯ liá»‡u báº¯t buá»™c: ${missing.join(', ')}`);
      return;
    }

    document.getElementById("status").innerText = "ğŸ”„ Äang táº¡o giao dá»‹ch...";

    try {
      const res = await fetch("/api/create-payment-url", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();

      if (result.paymentUrl) {
        console.log("âœ… Má»Ÿ tab má»›i tá»›i VNPAY:", result.paymentUrl);
        const vnpayTab = window.open(result.paymentUrl, "_blank");

        document.getElementById("status").innerText = "âœ… ÄÃ£ má»Ÿ trang thanh toÃ¡n.";

        // Nghe thÃ´ng bÃ¡o tá»« ReturnUrl á»Ÿ tab má»›i
        window.addEventListener("message", (event) => {
          if (event.data?.type === "vnpay_payment_complete") {
            console.log("ğŸ“¥ Nháº­n thÃ´ng bÃ¡o thanh toÃ¡n tá»« tab má»›i:", event.data);

            if (event.data.status === "success") {
              window.parent.postMessage({
                type: "custom_element_success_response",
                chargeId: event.data.chargeId
              }, "*");
              document.getElementById("status").innerText = "ğŸ‰ Thanh toÃ¡n thÃ nh cÃ´ng!";
            } else {
              window.parent.postMessage({
                type: "custom_element_error_response",
                error: { description: "Giao dá»‹ch tháº¥t báº¡i hoáº·c bá»‹ há»§y." }
              }, "*");
              document.getElementById("status").innerText = "âŒ Giao dá»‹ch tháº¥t báº¡i.";
            }
          }
        });
      } else {
        console.error("âŒ KhÃ´ng nháº­n Ä‘Æ°á»£c paymentUrl:", result);
        alert("âŒ KhÃ´ng thá»ƒ táº¡o link thanh toÃ¡n.");
      }
    } catch (err) {
      console.error("ğŸ”¥ Lá»—i khi táº¡o URL thanh toÃ¡n:", err);
      alert("âŒ CÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i.");
    }
  }
</script>
</body>
</html>
