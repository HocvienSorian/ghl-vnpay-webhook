async function initiatePayment(data) {
  const ipAddr = await getClientIp();

  const paymentLink = window.location.href; // 🟢 lấy URL hiện tại

  const payload = {
    amount: data.amount,
    orderId: data.orderId || data.transactionId || "ORD_FALLBACK",
    orderInfo: data.contactId,
    ipAddr,
    paymentLink // 🟢 truyền thêm paymentLink
  };

  const missing = Object.entries(payload).filter(([_, v]) => !v).map(([k]) => k);
  if (missing.length > 0) {
    console.error("❌ Thiếu trường:", missing);
    alert(`❌ Thiếu dữ liệu bắt buộc: ${missing.join(', ')}`);
    return;
  }

  document.getElementById("status").innerText = "🔄 Đang xử lý giao dịch...";

  try {
    const res = await fetch("/api/create-payment-url", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const result = await res.json();

    if (result.paymentUrl) {
      console.log("✅ Mở tab mới tới VNPAY:", result.paymentUrl);
      window.open(result.paymentUrl, "_blank");
      document.getElementById("status").innerText = "✅ Đã mở trang thanh toán.";
    } else {
      console.error("❌ Không nhận được paymentUrl:", result);
      alert("❌ Không thể tạo link thanh toán.");
    }
  } catch (err) {
    console.error("🔥 Lỗi gửi dữ liệu:", err);
    alert("❌ Có lỗi xảy ra. Vui lòng thử lại.");
  }
}
