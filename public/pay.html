<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C·ªïng Thanh To√°n VNPAY</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <h1>üßæ C·ªïng Thanh To√°n VNPAY</h1>
  <p id="status">‚è≥ ƒêang x·ª≠ l√Ω k·∫øt qu·∫£ thanh to√°n...</p>

<script>
  let paymentDataReceived = false;
  let fallbackData = null;

  window.addEventListener("load", () => {
    setTimeout(() => {
      console.log("üöÄ Iframe loaded ‚Äì g·ª≠i custom_provider_ready");
      window.parent.postMessage({
        type: "custom_provider_ready",
        loaded: true,
        providerId: "685ca9b987c1777791c22f89"
      }, "*");
    }, 300);
  });

  async function handleVnpayReturn() {
    const urlParams = new URLSearchParams(window.location.search);
    const vnp_ResponseCode = urlParams.get("vnp_ResponseCode");
    const vnp_TransactionNo = urlParams.get("vnp_TransactionNo");
    const vnp_TxnRef = urlParams.get("vnp_TxnRef");
    const vnp_SecureHash = urlParams.get("vnp_SecureHash");

    if (!vnp_ResponseCode || !vnp_TxnRef || !vnp_SecureHash) {
      console.log("‚ö†Ô∏è Kh√¥ng c√≥ tham s·ªë VNPAY trong URL, ti·∫øp t·ª•c flow c≈©");
      return;
    }

    console.log("üì• Nh·∫≠n callback t·ª´ VNPAY:", {
      vnp_ResponseCode, vnp_TransactionNo, vnp_TxnRef
    });

    document.getElementById("status").innerText = "üîç ƒêang x√°c minh giao d·ªãch v·ªõi GHL...";

    try {
      if (!fallbackData) {
        const res = await fetch("/api/fetch-ghl-transaction");
        fallbackData = await res.json();
        console.log("üì¶ Fallback transaction data:", fallbackData);
      }

      const verifyRes = await fetch("/api/vnpay-handler", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          type: "verify",
          chargeId: vnp_TransactionNo,
          transactionId: fallbackData.transactionId,
          contactId: fallbackData.contactId
        })
      });

      const result = await verifyRes.json();
      console.log("‚úÖ K·∫øt qu·∫£ verify:", result);

      if (verifyRes.ok && result.success) {
        window.parent.postMessage({
          type: "custom_element_success_response",
          chargeId: vnp_TransactionNo
        }, "*");
        document.getElementById("status").innerText = "üéâ Thanh to√°n th√†nh c√¥ng!";
      } else {
        window.parent.postMessage({
          type: "custom_element_error_response",
          error: { description: "Giao d·ªãch th·∫•t b·∫°i ho·∫∑c ch∆∞a x√°c minh." }
        }, "*");
        document.getElementById("status").innerText = "‚ùå Giao d·ªãch th·∫•t b·∫°i.";
      }
    } catch (err) {
      console.error("üî• L·ªói verify:", err);
      window.parent.postMessage({
        type: "custom_element_error_response",
        error: { description: "L·ªói x√°c minh giao d·ªãch." }
      }, "*");
      document.getElementById("status").innerText = "‚ùå L·ªói khi x√°c minh giao d·ªãch.";
    }
  }

  handleVnpayReturn();

  window.addEventListener("message", async (event) => {
    const data = event.data;
    console.log("üì• Nh·∫≠n d·ªØ li·ªáu t·ª´ GHL:", data);

    if (data?.type !== "payment_initiate_props") {
      console.warn("‚ö†Ô∏è Kh√¥ng ph·∫£i payment_initiate_props:", data?.type);
      return;
    }

    paymentDataReceived = true;
    await initiatePayment(data);
  });

  async function getClientIp() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip;
    } catch (err) {
      console.warn("‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c IP, d√πng fallback");
      return "127.0.0.1";
    }
  }

  async function initiatePayment(data) {
    const ipAddr = await getClientIp();

    const payload = {
      amount: data.amount,
      orderId: data.orderId || data.transactionId || "ORD_FALLBACK",
      orderInfo: data.contactId,
      ipAddr,
    };

    const missing = Object.entries(payload).filter(([_, v]) => !v).map(([k]) => k);
    if (missing.length > 0) {
      console.error("‚ùå Thi·∫øu tr∆∞·ªùng:", missing);
      alert(`‚ùå Thi·∫øu d·ªØ li·ªáu b·∫Øt bu·ªôc: ${missing.join(', ')}`);
      return;
    }

    document.getElementById("status").innerText = "üîÑ ƒêang x·ª≠ l√Ω giao d·ªãch...";

    try {
      const res = await fetch("/api/create-payment-url", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();

      if (result.paymentUrl) {
        console.log("‚úÖ M·ªü tab m·ªõi t·ªõi VNPAY:", result.paymentUrl);
        window.open(result.paymentUrl, "_blank");
        document.getElementById("status").innerText = "‚úÖ ƒê√£ m·ªü trang thanh to√°n.";
      } else {
        console.error("‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c paymentUrl:", result);
        alert("‚ùå Kh√¥ng th·ªÉ t·∫°o link thanh to√°n.");
      }
    } catch (err) {
      console.error("üî• L·ªói g·ª≠i d·ªØ li·ªáu:", err);
      alert("‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
    }
  }

  setTimeout(async () => {
    if (!paymentDataReceived) {
      console.warn("‚è± Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ GHL, g·ªçi fallback...");
      try {
        const res = await fetch("/api/fetch-ghl-transaction");
        fallbackData = await res.json();
        console.log("üì¶ Fallback transaction data:", fallbackData);
        await initiatePayment(fallbackData);
      } catch (err) {
        console.error("‚ùå L·ªói fallback:", err);
        document.getElementById("status").innerText = "‚ùå Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu giao d·ªãch.";
      }
    }
  }, 3000);
</script>
</body>
</html>
