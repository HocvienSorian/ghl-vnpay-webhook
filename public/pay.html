<script>
  window.addEventListener("load", () => {
    setTimeout(() => {
      console.log("🚀 Iframe loaded - sending custom_provider_ready");
      window.postMessage({
        type: "custom_provider_ready",
        loaded: true,
        addCardOnFileSupported: false
      }, "*");
    }, 300);
  });

  window.addEventListener("message", async (event) => {
    console.log("📥 Received from GHL:", event.data);
    if (event.data?.type !== "payment_initiate_props") return;

    const { amount, orderId, contactId } = event.data;
    console.log("🔄 Initiating payment:", { amount, orderId, contactId });

    try {
      const res = await fetch("/api/create-payment-url", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ amount, orderInfo: contactId, ipAddr: "127.0.0.1" })
      });
      const result = await res.json();
      if (result.paymentUrl) {
        console.log("✅ Redirecting to:", result.paymentUrl);
        window.open(result.paymentUrl, "_blank");
      }
    } catch (err) {
      console.error("❌ Error initiating payment:", err.message);
      window.parent.postMessage({
        type: "custom_element_error_response",
        error: { description: err.message }
      }, "*");
    }
  });
</script>
