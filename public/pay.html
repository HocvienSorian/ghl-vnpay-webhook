<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>C·ªïng Thanh To√°n VNPAY</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 40px;
    }
  </style>
</head>
<body>
  <h1>üßæ C·ªïng Thanh To√°n VNPAY</h1>
  <p id="status">‚è≥ ƒêang ch·ªù GHL g·ª≠i th√¥ng tin thanh to√°n...</p>

<script>
  let paymentDataReceived = false;

  window.addEventListener("load", () => {
    setTimeout(() => {
      console.log("üöÄ Iframe loaded ‚Äì g·ª≠i custom_provider_ready");
      window.postMessage({
        type: "custom_provider_ready",
        loaded: true,
        providerId: "685ca9b987c1777791c22f89"
      }, "*");
    }, 300);
  });

  async function getClientIp() {
    try {
      const res = await fetch("https://api.ipify.org?format=json");
      const data = await res.json();
      return data.ip;
    } catch (err) {
      console.warn("‚ö†Ô∏è Kh√¥ng l·∫•y ƒë∆∞·ª£c IP, d√πng fallback");
      return "127.0.0.1";
    }
  }

  async function initiatePayment(data) {
    const ipAddr = await getClientIp();

    const payload = {
      amount: data.amount,
      orderId: data.orderId || data.transactionId || "ORD_FALLBACK",
      orderInfo: data.contactId,
      ipAddr,
    };

    const missing = Object.entries(payload).filter(([_, v]) => !v).map(([k]) => k);
    if (missing.length > 0) {
      console.error("‚ùå Thi·∫øu tr∆∞·ªùng:", missing);
      alert(`‚ùå Thi·∫øu d·ªØ li·ªáu b·∫Øt bu·ªôc: ${missing.join(', ')}`);
      return;
    }

    document.getElementById("status").innerText = "üîÑ ƒêang x·ª≠ l√Ω giao d·ªãch...";

    try {
      const res = await fetch("/api/create-payment-url", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const result = await res.json();

      if (result.paymentUrl) {
        console.log("‚úÖ M·ªü tab m·ªõi t·ªõi VNPAY:", result.paymentUrl);
        const vnpayTab = window.open(result.paymentUrl, "_blank"); // ‚úÖ m·ªü tab m·ªõi tr√°nh b·ªã ch·∫∑n
        document.getElementById("status").innerText = "‚úÖ ƒê√£ m·ªü trang thanh to√°n.";

        // üÜï Nghe th√¥ng b√°o t·ª´ ReturnUrl (tab m·ªõi)
        window.addEventListener("message", (event) => {
          if (event.data?.type === "vnpay_payment_complete") {
            console.log("üì• Nh·∫≠n th√¥ng b√°o thanh to√°n t·ª´ tab m·ªõi:", event.data);

            if (event.data.status === "success") {
              window.parent.postMessage({
                type: "custom_element_success_response",
                chargeId: event.data.chargeId
              }, "*");
              document.getElementById("status").innerText = "üéâ Thanh to√°n th√†nh c√¥ng!";
            } else {
              window.parent.postMessage({
                type: "custom_element_error_response",
                error: { description: "Giao d·ªãch th·∫•t b·∫°i ho·∫∑c b·ªã h·ªßy." }
              }, "*");
              document.getElementById("status").innerText = "‚ùå Giao d·ªãch th·∫•t b·∫°i.";
            }
          }
        });
      } else {
        console.error("‚ùå Kh√¥ng nh·∫≠n ƒë∆∞·ª£c paymentUrl:", result);
        alert("‚ùå Kh√¥ng th·ªÉ t·∫°o link thanh to√°n.");
      }
    } catch (err) {
      console.error("üî• L·ªói g·ª≠i d·ªØ li·ªáu:", err);
      alert("‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.");
    }
  }

  window.addEventListener("message", async (event) => {
    const data = event.data;
    console.log("üì• Nh·∫≠n d·ªØ li·ªáu t·ª´ GHL:", data);

    if (data?.type !== "payment_initiate_props") {
      console.warn("‚ö†Ô∏è Kh√¥ng ph·∫£i payment_initiate_props:", data?.type);
      return;
    }

    paymentDataReceived = true;
    await initiatePayment(data);
  });

  setTimeout(async () => {
    if (!paymentDataReceived) {
      console.warn("‚è± Kh√¥ng c√≥ d·ªØ li·ªáu t·ª´ GHL, g·ªçi fallback...");
      try {
        const res = await fetch("/api/fetch-ghl-transaction");
        const fallbackData = await res.json();
        console.log("üì¶ Fallback transaction data:", fallbackData);
        await initiatePayment(fallbackData);
      } catch (err) {
        console.error("‚ùå L·ªói fallback:", err);
        document.getElementById("status").innerText = "‚ùå Kh√¥ng th·ªÉ l·∫•y d·ªØ li·ªáu giao d·ªãch.";
      }
    }
  }, 3000);
</script>
</body>
</html>
